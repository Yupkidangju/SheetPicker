name: Build and Release

# íƒœê·¸ í‘¸ì‹œ ì‹œ ìë™ ë¹Œë“œ + ë¦´ë¦¬ì¦ˆ ìƒì„±
# ì‚¬ìš©ë²•: git tag v2.0.0 && git push origin v2.0.0
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka

    - name: Build with Nuitka
      run: |
        python -m nuitka --standalone --onefile --enable-plugin=pyside6 --include-package=pandas --include-package=openpyxl --windows-console-mode=disable --company-name=Antigravity --product-name="Data Scavenger" --file-version=${{ github.ref_name }} --product-version=${{ github.ref_name }} --file-description="ê³ ì„±ëŠ¥ Excel/CSV ê²€ìƒ‰ ë„êµ¬" --output-filename=DataScavenger.exe src/main.py

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: "Data Scavenger ${{ github.ref_name }}"
        body: |
          ## Data Scavenger ${{ github.ref_name }}

          ### ë‹¤ìš´ë¡œë“œ
          ì•„ë˜ `DataScavenger.exe`ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì‹¤í–‰í•˜ì„¸ìš”.
          Python ì„¤ì¹˜ ì—†ì´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

          ### ì£¼ìš” ê¸°ëŠ¥
          - ğŸ” 4ê³„ì¸µ ê²€ìƒ‰ ì—”ì§„ (ì •í™•/í¼ì§€/ì´ˆì„±/BM25)
          - âš¡ ì¸ë±ì‹± ê¸°ë°˜ ê³ ì† ê²€ìƒ‰ (<100ms)
          - ğŸ“¤ ê²€ìƒ‰ ê²°ê³¼ xlsx/csv ë‚´ë³´ë‚´ê¸°
          - â­ íŒŒì¼ ì„¸íŠ¸ ì¦ê²¨ì°¾ê¸°
          - ğŸ¨ ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ
        files: |
          DataScavenger.exe
        draft: false
        prerelease: false

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13"]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run Tests with pytest
      env:
        PYTHONPATH: .
        QT_QPA_PLATFORM: offscreen
      run: |
        pytest --tb=short -v
